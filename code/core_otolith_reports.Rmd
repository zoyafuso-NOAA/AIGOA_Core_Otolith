---
title: "Core otolith analysis request for `r species_name`"
output: html_document
author: "POC: Zack Oyafuso (zack.oyafuso@noaa.gov)"
---

```{r Constants, echo = F}

sa_author <- collection$PI[irow]
threshold <- collection$criteria_value[irow]

target_requested <- !is.na(collection$total_requested[irow])
target_n <- collection$total_requested[irow]

```

## Purpose

The goal is to assess the feasibility of the otolith request for 
`r species_name` requested by `r sa_author`. 

## Collection rule

* Collect no more than these quantites of otolith pairs according to the
management area:

| **Management Area**            | **Quantity**             |
|:------------------------------:|:------------------------:|
| Southern Bering Sea (SBS)      | `r collection$SBS[irow]` |
| Eastern Aleutian Islands (EAI) | `r collection$EAI[irow]` |
| Central Aleutian Islands (CAI) | `r collection$CAI[irow]` |
| Western Aleutian Islands (WAI) | `r collection$WAI[irow]` |

```{r echo = F,  results = "asis"}

string <- ifelse(test = collection$criteria[irow] == "threshold", 
                 yes = paste0("* If >= ", collection$criteria_value[irow], 
                                  " are collected, do not collect."),
                 no = "")
cat(string)
```

## Bootstrapped Results

For the last five survey years, hauls were sampled with replacement until a 
bootstrapped sample of 420 hauls were obtained. The collection rule was applied
to each haul and the total number of otoliths collected was totaled. This was
repeated 1000 times to obtain a distribution of total otoliths collected 
conditional on the collection rule requested this year. 

```{r, echo = F}

layout(mat = matrix(1:2, byrow = T, nrow = 1), 
       widths = c(1, 0.5))

## Calculate quantiles of the total otoliths collected
    temp_dist <- apply(X = bootstrap_oto_main[, irow, ], 
                       MARGIN = 1, 
                       FUN = quantile, 
                       probs = c(0.025, 0.25, 0.5, 0.75, 0.975) )
    
    if(is.na(target_n)) target_n <- max(temp_dist["50%", ])
    
    ## Base plot
    plot(temp_dist["50%", ], type = "n", axes = F, ann = F,
         ylim = range(c(c(1.25, 0.75) * target_n, 
                        temp_dist[c("2.5%", "97.5%"), ])) )
    
    ## Plot boxplot time series
    polygon(x = c(1:5, 5:1), 
            y = c(temp_dist["2.5%", ], rev(temp_dist["97.5%", ])),
            col = "cornflowerblue", border = F)
    
    polygon(x = c(1:5, 5:1), 
            y = c(temp_dist["25%", ], rev(temp_dist["75%", ])),
            col = "darkgreen", border = F)
    
    lines(x = 1:5, y = temp_dist["50%", ], lwd = 2)
    points(x = 1:5, y = temp_dist["50%", ], pch = 16, cex = 1.5)
    
    ## Add target total collection
    if(target_requested) abline(h = target_n, lty = 'dashed')
    
    ## Add observed total collection
    # points(x = 1:5, y = total_ages[species_name, ], 
    #        pch = "*", col = "red", cex = 2)
    
    ## Axis Labels
    box()
    axis(side = 1, at = 1:5, labels = c(2010, 2012, 2014, 2016, 2018))
    axis(side = 2, las = 1)
    mtext(side = 3, text = species_name, line = 0.5)
  mtext(side = 1, text = "Year", font = 2, line = 3)
  mtext(side = 2, text = "Total Otoliths Collected", font = 2, line = 3)
  
    ## Add Legend
    par(mar = c(2, 0, 2, 2))
  plot(1, type = "n", axes = F, ann = F, xlim = c(3, 8), ylim = c(0, 100))
  rect(xleft = 4, xright = 6, ybottom = 5, ytop = 95, 
       col = "cornflowerblue", border = "cornflowerblue")
  rect(xleft = 4, xright = 6, ybottom = 25, ytop = 75, 
       col = "darkgreen", border = "darkgreen")
  points(x = 5, y = 50, pch = 16)
  text(x = 6, y = c(5, 25, 50, 75, 95), 
       labels = paste0(c(2.5, 25, 50, 75, 97.5), "%"), pos = 4)
  mtext(side = 3, text = "percentile", line = -1)
  

```

