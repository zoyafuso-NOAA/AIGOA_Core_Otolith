---
output: github_document
---

```{css, echo=FALSE}
body {
  background-color: white;
} 

h1 {
  color: black;
  text-align: center;
}

h2 {
  color: black;
  text-align: center;
}

.flat-table {
  display: block;
  font-family: sans-serif;
  -webkit-font-smoothing: antialiased;
  font-size: 115%;
  overflow: auto;
  width: auto;
}
th {
  background-color: rgb(112, 196, 105);
  color: black;
  font-weight: bold;
  padding: 20px 30px;
  text-align: center;
}
td {
  background-color: rgb(238, 238, 238);
  color: rgb(111, 111, 111);
  padding: 20px 30px;
}


```

# Aleutian Island 2022 Bottom Trawl Survey 
## [Core Otolith Requests](#top) 

The goal is to assess the feasibility of the core otolith request using haul
data from the past five survey years. Requests for each species include 
collection rules and a total otolith pair requested. The main questions 
that drive the feasibility of the requeted core otolith requests are:

1) Given the requested collection rules, how well could the survey achieve the
requested target across species?
2) What is the total amount of otolith pairs collected over the survey?
3) How many otolith pairs are collected during each haul?
4) Given 30 otolith pairs are a maximum haul-total, how often are hauls over
this threshold?

For the last five survey years, hauls were sampled with replacement until a 
bootstrapped sample of 420 hauls were obtained. The collection rule was applied
to each haul and the total number of otoliths collected was totaled. This was
repeated 1000 times to obtain a distribution of total otoliths collected 
conditional on the collection rule requested this year. 

Below are the species (and associated stock assessment authors) requested for
otolith collections. Click on the 


```{r echo = F, warning = F}
library(rmarkdown)
library(readxl)
library(glue)

###############################################################################
####   Load bootstrap results and collection spreadsheet
###############################################################################
load("results/bootstrap_results.RData")
collection <- readxl::read_xlsx("data/AI_core_collections.xlsx", 
                                sheet = "2022 collection")
```

```{r, echo = F, results = "asis", class.source = "flat-table"}

string <- glue::glue( "| Common Name | Stock Assessment Author |
   |:-----------:|:-----------------------:|")

for (irow in order(collection$PI)) {
  html_species <-
    gsub(x = collection$common_name[irow],
         pattern = " ",
         replacement = "_")
  string <- glue::glue(string,
                       "\n| [{collection$common_name[irow]}](#{gsub(x = collection$common_name[irow], pattern = ' ', replacement = '-')})| {collection$PI[irow]}  |")
}

cat(string)

```

## Summary

```{r, echo = F}
############################################################################
  ####   Plot boxplot time series of total per-haul otoliths
  ####   
  ####   For each bootstrapped sample, you have a calculation of the quantiles
  ####      (2.5, 25, 50, 75, 97.5%) of total number of otoliths collected 
  ####      across the 420 stations. For each quantile, there is a distribution
  ####      of 1000 values. Calculate the medians of those distributions
  ############################################################################
  total_work <- apply(X = bootstrap_total_work,
                      MARGIN = c(1, 2),
                      FUN = median)

median_total_otoliths <- apply(X = apply(X = bootstrap_oto_main, 
                                     MARGIN = c(1, 3), 
                                     FUN = sum), 
                               MARGIN = 1, 
                               FUN = median)
median_over_thirty <- round(100 * apply(X = bootstrap_over_thirty, 
                                        MARGIN = 1, 
                                        FUN = median))
```

Under the requested collection rules, between `r min(median_total_otoliths)` 
and `r max(median_total_otoliths)` total otolith pairs (median values) were
collected from bootstrapped surveys over the past five survey years. 
Haul-level otolith totals ranged from `r min(total_work[, "50%"])` and 
`r  max(total_work[, "50%"])` otolith pairs, with 
`r min(median_over_thirty)`-`r max(median_over_thirty)`% of hauls over 
collecting over 30 otolith pairs.

```{r, echo = F}

  
par(mfrow = c(2, 2), mar = c(3, 3, 3, 1))

  ##################################################
  ####   
  ##################################################  
  ## Base plot
  plot(1, type = "n", axes = F, ann = F,
       xlim = c(1, 5),
       ylim = range(total_work) )
  
  ## Plot boxplot time series
  polygon(x = c(1:5, 5:1), 
          y = c(total_work[, "2.5%"], rev(total_work[, "97.5%"])),
          col = "cornflowerblue", border = F)
  
  polygon(x = c(1:5, 5:1), 
          y = c(total_work[, "25%"], rev(total_work[, "75%"])),
          col = "darkgreen", border = F)
  
  lines(x = 1:5, y = total_work[, "50%"], lwd = 2)
  points(x = 1:5, y = total_work[, "50%"], pch = 16, cex = 1.5)
  
  ## Axis Labels
  box()
  axis(side = 1, at = 1:5, labels = c(2010, 2012, 2014, 2016, 2018))
  axis(side = 2, las = 1)
  mtext(side = 3, text = "Haul-Level total otoliths", line = 0.5)
  
  ############################################################################
  ####   Plot 
  ############################################################################
  total_work <- apply(X = bootstrap_oto_main,
                      MARGIN = c(1, 3),
                      FUN = sum)
  total_work <- apply(X = total_work, 
                      MARGIN = 1,
                      FUN = quantile,
                      probs = c(0.025, 0.25, 0.50, 0.75, 0.975))
  
  ## Base plot
  plot(1, type = "n", axes = F, ann = F,
       xlim = c(1, 5),
       ylim = range(total_work) )
  
  ## Plot boxplot time series
  polygon(x = c(1:5, 5:1), 
          y = c(total_work["2.5%", ], rev(total_work["97.5%", ])),
          col = "cornflowerblue", border = F)
  
  polygon(x = c(1:5, 5:1), 
          y = c(total_work["25%", ], rev(total_work["75%", ])),
          col = "darkgreen", border = F)
  
  lines(x = 1:5, y = total_work["50%", ], lwd = 2)
  points(x = 1:5, y = total_work["50%", ], pch = 16, cex = 1.5)
  
  ## Axis Labels
  box()
  axis(side = 1, at = 1:5, labels = c(2010, 2012, 2014, 2016, 2018))
  axis(side = 2, las = 1)
  mtext(side = 3, text = "Total otoliths", line = 0.5)
  
  abline(h = sum(collection$total_requested), lty = 'dashed')
  
  ############################################################################
  ####   Plot percentage of > 30 collections
  ############################################################################
  total_work <- apply(X = bootstrap_over_thirty, 
                      MARGIN = 1,
                      FUN = quantile,
                      probs = c(0.025, 0.25, 0.50, 0.75, 0.975))
  
  ## Base plot
  plot(1, type = "n", axes = F, ann = F,
       xlim = c(1, 5),
       ylim = range(total_work) )
  
  ## Plot boxplot time series
  polygon(x = c(1:5, 5:1), 
          y = c(total_work["2.5%", ], rev(total_work["97.5%", ])),
          col = "cornflowerblue", border = F)
  
  polygon(x = c(1:5, 5:1), 
          y = c(total_work["25%", ], rev(total_work["75%", ])),
          col = "darkgreen", border = F)
  
  lines(x = 1:5, y = total_work["50%", ], lwd = 2)
  points(x = 1:5, y = total_work["50%", ], pch = 16, cex = 1.5)
  
  ## Axis Labels
  box()
  axis(side = 1, at = 1:5, labels = c(2010, 2012, 2014, 2016, 2018))
  axis(side = 2, las = 1)
  mtext(side = 3, text = "Prop. > 30 otoliths", line = 0.5)
  
```

```{r, echo=FALSE, message=FALSE, results="asis"}


for (irow in 1:(nrow(collection) - 1)) {
  cat("  \n##", collection$common_name[irow], "\n\n")
  cat("[top](#top)\n\n")
  string <- glue::glue(
    "| **Management Area**            | **Quantity**             |
 |:------------------------------:|:------------------------:|
 | Southern Bering Sea (SBS)      | {collection$SBS[irow]} |
 | Eastern Aleutian Islands (EAI) | {collection$EAI[irow]} |
 | Central Aleutian Islands (CAI) | {collection$CAI[irow]} |
 | Western Aleutian Islands (WAI) | {collection$WAI[irow]} |")
  
  cat(string)
  cat("\n\n")
  
  string <- ifelse(test = collection$criteria[irow] == "threshold", 
                   yes = paste0("* If < ", collection$criteria_value[irow], 
                                " are collected, do not collect."),
                   no = "")
  cat(string)
  cat("\n\n")
  
  species_name <- collection$common_name[irow]
  
  sa_author <- collection$PI[irow]
  threshold <- collection$criteria_value[irow]
  
  target_requested <- !is.na(collection$total_requested[irow])
  target_n <- collection$total_requested[irow]
  
  
  layout(mat = matrix(1:2, byrow = T, nrow = 1),
         widths = c(1, 0.5))
  
  ## Calculate quantiles of the total otoliths collected
  temp_dist <- apply(X = bootstrap_oto_main[, irow, ],
                     MARGIN = 1,
                     FUN = quantile,
                     probs = c(0.025, 0.25, 0.5, 0.75, 0.975) )
  
  if(is.na(target_n)) target_n <- max(temp_dist["50%", ])
  
  ## Base plot
  par(mar = c(5, 5, 3, 0))
  plot(temp_dist["50%", ], type = "n", axes = F, ann = F,
       ylim = range(c(c(1.25, 0.75) * target_n,
                      temp_dist[c("2.5%", "97.5%"), ])) )
  
  ## Plot boxplot time series
  polygon(x = c(1:5, 5:1),
          y = c(temp_dist["2.5%", ], rev(temp_dist["97.5%", ])),
          col = "cornflowerblue", border = F)
  
  polygon(x = c(1:5, 5:1),
          y = c(temp_dist["25%", ], rev(temp_dist["75%", ])),
          col = "darkgreen", border = F)
  
  lines(x = 1:5, y = temp_dist["50%", ], lwd = 2)
  points(x = 1:5, y = temp_dist["50%", ], pch = 16, cex = 1.5)
  
  ## Add target total collection
  if(target_requested) abline(h = target_n, lty = 'dashed')
  
  ## Add observed total collection
  # points(x = 1:5, y = total_ages[species_name, ],
  #        pch = "*", col = "red", cex = 2)
  
  ## Axis Labels
  box()
  axis(side = 1, at = 1:5, labels = c(2010, 2012, 2014, 2016, 2018))
  axis(side = 2, las = 1)
  mtext(side = 3, text = species_name, line = 1, font = 2)
  mtext(side = 1, text = "Year", font = 2, line = 3)
  mtext(side = 2, text = "Total Otoliths Collected", font = 2, line = 3)
  
  ## Add Legend
  par(mar = c(2, 0, 2, 2))
  plot(1, type = "n", axes = F, ann = F, xlim = c(3, 8), ylim = c(0, 100))
  rect(xleft = 4, xright = 6, ybottom = 5, ytop = 95,
       col = "cornflowerblue", border = "cornflowerblue")
  rect(xleft = 4, xright = 6, ybottom = 25, ytop = 75,
       col = "darkgreen", border = "darkgreen")
  points(x = 5, y = 50, pch = 16)
  text(x = 6, y = c(5, 25, 50, 75, 95),
       labels = paste0(c(2.5, 25, 50, 75, 97.5), "%"), pos = 4)
  mtext(side = 3, text = "percentile", line = -1, font = 2)
  
  cat("\n\n")
}
```
